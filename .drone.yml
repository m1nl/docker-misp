---
kind: pipeline
type: kubernetes
name: default

concurrency:
  limit: 1

environment:
  MISP_TAG: v2.4.183
  MODULES_TAG: v2.4.182
  PHP_VER: 20190902
  REDIS_VER: 7.2.4-alpine
  MARIADB_VER: 10.9.8-jammy

steps:
  - name: build_publish_server
    image: plugins/kaniko
    registry: registry.nalewajski.pl
    repo: m1nl/misp-server
    username:
      from_secret: dockerhub_username
    password:
      from_secret: dockerhub_password
    dockerfile: server/Dockerfile
    context: server/
    build_args:
      - MISP_TAG
      - MODULES_TAG
      - PHP_VER
    auto_tag: true

  - name: build_publish_modules
    image: plugins/kaniko
    registry: registry.nalewajski.pl
    repo: m1nl/misp-modules
    username:
      from_secret: dockerhub_username
    password:
      from_secret: dockerhub_password
    dockerfile: modules/Dockerfile
    context: modules/
    build_args:
      - MISP_TAG
      - MODULES_TAG
      - PHP_VER
    auto_tag: true

  - name: notify_failure
    image: drillster/drone-email
    settings:
      host:
        from_secret: mail_host
      username:
        from_secret: mail_username
      password:
        from_secret: mail_password
      from:
        from_secret: drone_sender
      recipients:
        from_secret: drone_recipients
      recipients_only: true
    when:
      status:
      - failure

concurrency:
  limit: 1
---
kind: signature
hmac: 888c8f11f0d1f773fa2d41c8b410c04d31298b6e7c872ddd831e01b682de818b

...
